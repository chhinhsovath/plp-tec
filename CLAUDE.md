# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PLP TEC LMS is a comprehensive Learning Management System for Teacher Education Colleges in Cambodia. It's a nationwide system with role-based access control, AI-powered chat features, and extensive educational tools.

## Essential Commands

### Development
```bash
npm run dev          # Start development server (port 3000)
pnpm dev            # Alternative with pnpm
```

### Database Operations
```bash
npm run db:migrate          # Create new migrations in development
npm run db:migrate:deploy   # Apply migrations to production
npm run db:push            # Push schema changes without migration (dev only)
npm run db:seed            # Seed database with initial data
npm run db:reset           # Reset database and reapply migrations
npm run db:studio          # Open Prisma Studio GUI
npm run db:add-admin       # Add admin user via script
```

### Build & Production
```bash
npm run build       # Build for production (runs prisma generate first)
npm run start       # Start production server
npm run lint        # Run ESLint
```

### Testing Database Connection
```bash
npm run db:verify   # Verify database connection
npm run db:init     # Initialize database structure
npm run db:setup    # Run migrations and seed data
```

## Architecture & Key Design Decisions

### Tech Stack
- **Frontend**: Next.js 14 App Router, React 18, TypeScript
- **UI Library**: Ant Design (replaced DaisyUI for licensing reasons)
- **Styling**: Tailwind CSS + Ant Design theme
- **Database**: PostgreSQL with Prisma ORM
- **Authentication**: NextAuth.js with credentials provider
- **AI Integration**: OpenRouter API (supports multiple models including Google Gemma)
- **Real-time**: Socket.io (configured but not fully implemented)

### Core Architectural Patterns

1. **App Router Structure**: All pages use Next.js 14 App Router in `src/app/`
   - API routes in `src/app/api/`
   - Pages use `'use client'` directive for client components
   - Server components for initial data fetching where possible

2. **Authentication Flow**:
   - NextAuth handles auth via `/api/auth/*` routes
   - Session checks in client components use `useSession()` hook
   - API routes verify auth using `getServerSession(authOptions)`
   - Middleware-free approach (auth checks in individual routes)

3. **Database Schema Design**:
   - **SystemRole enum**: Basic roles (ADMIN, INSTRUCTOR, STUDENT, GUEST)
   - **Role-based system**: Comprehensive 27-role system with permissions
   - UserRole model links users to roles with institution/department scope
   - Hierarchical role levels (1 = highest authority)

4. **AI Chat Implementation**:
   - Standard chat at `/api/chat` 
   - Vision-capable chat at `/api/chat/vision`
   - Uses OpenRouter API with configurable models
   - Chat history stored in ChatMessage model
   - Permission-based access (`chat:access`)

5. **Component Organization**:
   - Shared layout component: `src/components/Layout/AppLayout.tsx`
   - Provider pattern: `AntdProvider` wraps Ant Design config
   - Page-level components handle their own data fetching

### Environment Configuration

Required environment variables:
```env
DATABASE_URL=postgresql://user:pass@host:port/db
NEXTAUTH_URL=https://tec.openplp.com
NEXTAUTH_SECRET=<generate with openssl rand -base64 32>
OPENROUTER_API_KEY=sk-or-...
OPENROUTER_MODEL=google/gemma-3-27b-it:free
```

Production database config (from README):
- Host: 157.10.73.52
- Port: 5432
- Database: plp_tec
- User: admin

### Key Implementation Details

1. **Role Permissions System**:
   - Permissions follow `resource:action` pattern
   - Helper functions in `src/lib/permissions.ts`
   - Check permissions with `hasPermission(userId, resource, action)`
   - Role hierarchy enforced (can only manage equal/lower roles)

2. **API Route Pattern**:
   - All routes check authentication first
   - Use Zod for request validation
   - Return consistent error responses
   - Rate limiting implemented for chat endpoints

3. **UI Components Migration**:
   - Recently migrated from DaisyUI to Ant Design
   - Custom theme colors defined in `AntdProvider`
   - Mix of Tailwind utilities and Ant Design components
   - Responsive design using Ant Grid system

4. **File Upload & Resources**:
   - Resources stored with metadata in database
   - File URLs reference external storage
   - Download tracking via ResourceAccess model

### Common Development Scenarios

When adding new features:
1. Create/update Prisma schema models
2. Run `npm run db:migrate` to create migration
3. Update TypeScript types (auto-generated by Prisma)
4. Implement API route with auth checks
5. Create UI components using Ant Design
6. Add permission checks if role-based

When modifying roles/permissions:
1. Update `prisma/seed-roles.ts` 
2. Add new permissions to permissions array
3. Map permissions to roles in rolePermissionMappings
4. Run `npx tsx prisma/seed-roles.ts` to update

### Production Deployment

The app is configured for:
- Vercel deployment (see build output)
- Docker deployment (Dockerfile referenced but not present)
- Uses pnpm in production (lockfile present)
- Static generation where possible, SSR for dynamic routes